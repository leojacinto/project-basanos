# ITSM Business Logic Constraints
#
# These are declarative constraint definitions that any operator
# can customize for their environment. No TypeScript required.
#
# Condition syntax:
#   - field: metadata key to check
#   - operator: eq, neq, gt, gte, lt, lte, in, exists
#   - value: expected value (or omit for 'exists')
#
# When multiple conditions are listed, ALL must be true (AND logic).
# For OR logic, create separate constraints.

constraints:

  - id: itsm:change_freeze_active
    name: Active Change Freeze
    domain: itsm
    appliesTo: [incident]
    relevantActions: [resolve, close, auto_resolve]
    severity: block
    description: >
      Prevents incident resolution actions during an active change freeze.
      When a change freeze is in effect, incident resolution may require
      changes that violate the freeze window. Escalate to change management.
    conditions:
      - field: change_freeze_active
        operator: eq
        value: true
    violationMessage: >
      An active change freeze is in effect. Incident resolution may require
      changes that violate the freeze window. Escalate to change management.
    satisfiedMessage: No active change freeze detected.

  - id: itsm:p1_reassignment_caution
    name: P1 Reassignment Caution
    domain: itsm
    appliesTo: [incident]
    relevantActions: [reassign]
    severity: warn
    description: >
      P1 incidents typically have active war rooms, executive visibility,
      and established communication channels. Reassignment disrupts all of
      these and should be done deliberately, not automatically.
    conditions:
      - field: priority
        operator: eq
        value: P1
    violationMessage: >
      This is a P1 incident. Reassignment will disrupt the active war room
      and escalation chain. Confirm with the incident commander before proceeding.
    satisfiedMessage: Incident is not P1. Standard reassignment procedures apply.

  - id: itsm:group_capacity_check
    name: Assignment Group Capacity
    domain: itsm
    appliesTo: [incident, problem, change_request]
    relevantActions: [assign, reassign]
    severity: warn
    description: >
      Checks whether the target assignment group has available capacity.
      Overloaded groups lead to SLA breaches and burnout.
    conditions:
      - field: target_group_active_tickets
        operator: gt
        value: 0
      - field: target_group_ticket_ratio
        operator: gt
        value: 10
    violationMessage: >
      Target group ticket-to-member ratio exceeds threshold.
      Consider alternative assignment or escalation.
    satisfiedMessage: Target group capacity is within acceptable range.

  - id: itsm:sla_breach_review
    name: SLA Breach Review Required
    domain: itsm
    appliesTo: [incident]
    relevantActions: [close]
    severity: warn
    description: >
      If an incident breached its SLA and the governing SLA contract has a
      penalty clause, the closure should be reviewed by service management
      before finalizing. Documentation of the breach is required.
    conditions:
      - field: sla_breached
        operator: eq
        value: true
      - field: sla_has_penalty
        operator: eq
        value: true
    violationMessage: >
      This incident breached an SLA with a penalty clause. Closure requires
      a documented breach review. Route to service level management before closing.
    satisfiedMessage: No SLA penalty breach detected. Standard closure procedures apply.
